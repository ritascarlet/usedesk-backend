<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∞–º–∏</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: linear-gradient(135deg, #60a5fa 0%, #2563eb 70%, #1e40af 100%);
            margin: 0;
            padding: 24px;
            min-height: 100vh;
            background-attachment: fixed;
        }
        
        @keyframes pulse {
            0% { opacity: 0.7; transform: scale(0.98); }
            50% { opacity: 0.9; transform: scale(1.0); }
            100% { opacity: 0.7; transform: scale(0.98); }
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(60px);
            border-radius: 32px;
            padding: 20px;
            border: 1.5px solid rgba(255, 255, 255, 0.25);
            box-shadow: 0 24px 48px rgba(0, 0, 0, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.25);
        }
        .inner-container {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(60px);
            border-radius: 28px;
            padding: 28px;
            border: 1.5px solid rgba(255, 255, 255, 0.25);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }
        .header {
            text-align: center;
            margin-bottom: 32px;
        }
        .title {
            color: #ffffff;
            font-size: 36px;
            font-weight: 900;
            margin-bottom: 12px;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        .subtitle {
            color: rgba(255, 255, 255, 0.9);
            font-size: 18px;
            font-weight: 600;
            text-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
        }
        .subscription-card {
            background: rgba(255, 255, 255, 0.14);
            backdrop-filter: blur(60px);
            border-radius: 28px;
            padding: 18px 24px;
            margin-bottom: 16px;
            border: 1.5px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 10px 36px rgba(0, 0, 0, 0.12), inset 0 1px 0 rgba(255, 255, 255, 0.3);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        .subscription-card:hover {
            transform: translateY(-4px) scale(1.015);
            box-shadow: 0 28px 68px rgba(0, 0, 0, 0.18), inset 0 1px 0 rgba(255, 255, 255, 0.35);
            background: rgba(255, 255, 255, 0.18);
        }
        .subscription-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.7), transparent);
            border-radius: 28px 28px 0 0;
        }
        .subscription-name {
            color: #ffffff;
            font-size: 22px;
            font-weight: 800;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        .subscription-expires {
            color: rgba(255, 255, 255, 0.9);
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 20px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }
        .quickinstall-btn {
            background: rgba(79, 172, 254, 0.22);
            backdrop-filter: blur(60px);
            color: #ffffff;
            border: none;
            border-radius: 24px;
            padding: 14px 24px;
            font-size: 14px;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1.5px solid rgba(255, 255, 255, 0.35);
            box-shadow: 0 10px 36px rgba(79, 172, 254, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.3);
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        .quickinstall-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 18px 52px rgba(79, 172, 254, 0.45), inset 0 1px 0 rgba(255, 255, 255, 0.4);
            background: rgba(79, 172, 254, 0.28);
        }
        .replace-key-btn {
            background: rgba(239, 68, 68, 0.22);
            backdrop-filter: blur(60px);
            color: #ffffff;
            border: none;
            border-radius: 24px;
            padding: 14px 24px;
            font-size: 14px;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1.5px solid rgba(255, 255, 255, 0.35);
            box-shadow: 0 10px 36px rgba(239, 68, 68, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.3);
            margin-left: 12px;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        .replace-key-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 18px 52px rgba(239, 68, 68, 0.45), inset 0 1px 0 rgba(255, 255, 255, 0.4);
            background: rgba(239, 68, 68, 0.28);
        }
        .button-container {
            display: flex;
            gap: 16px;
            align-items: center;
            flex-wrap: wrap;
        }
        .back-btn {
            background: rgba(255, 255, 255, 0.17);
            backdrop-filter: blur(60px);
            color: #ffffff;
            border: none;
            border-radius: 24px;
            padding: 12px 24px;
            font-size: 15px;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-decoration: none;
            display: inline-block;
            margin-bottom: 24px;
            border: 1.5px solid rgba(255, 255, 255, 0.35);
            box-shadow: 0 10px 36px rgba(0, 0, 0, 0.12), inset 0 1px 0 rgba(255, 255, 255, 0.3);
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        .back-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 18px 52px rgba(0, 0, 0, 0.18), inset 0 1px 0 rgba(255, 255, 255, 0.4);
            background: rgba(255, 255, 255, 0.22);
        }
        
        .subscription-card {
            opacity: 1;
        }
        
        .cache-delete-btn {
            background: rgba(255, 140, 0, 0.22);
            backdrop-filter: blur(60px);
            color: #ffffff;
            border: none;
            border-radius: 24px;
            padding: 11px 22px;
            font-size: 14px;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1.5px solid rgba(255, 255, 255, 0.35);
            box-shadow: 0 10px 36px rgba(255, 140, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.3);
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        .cache-delete-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 18px 52px rgba(255, 140, 0, 0.45), inset 0 1px 0 rgba(255, 255, 255, 0.4);
            background: rgba(255, 140, 0, 0.28);
        }
        .split-container {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 24px;
            align-items: start;
        }
        @media (max-width: 1024px) {
            .split-container {
                grid-template-columns: 1fr;
            }
        }
        .devices-panel {
            background: rgba(255, 255, 255, 0.14);
            backdrop-filter: blur(60px);
            border-radius: 28px;
            padding: 24px;
            border: 1.5px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 10px 36px rgba(0, 0, 0, 0.12), inset 0 1px 0 rgba(255, 255, 255, 0.35);
            position: sticky;
            top: 24px;
            max-height: calc(100vh - 48px);
            overflow-y: auto;
        }
        .devices-title {
            color: #ffffff;
            font-size: 20px;
            font-weight: 900;
            margin-bottom: 18px;
            text-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .device-card {
            background: rgba(255, 255, 255, 0.16);
            backdrop-filter: blur(60px);
            border-radius: 26px;
            padding: 18px 20px;
            margin-bottom: 14px;
            border: 1.5px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 10px 36px rgba(0, 0, 0, 0.12), inset 0 1px 0 rgba(255, 255, 255, 0.35);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        .device-card:hover {
            transform: translateY(-4px) scale(1.015);
            box-shadow: 0 28px 68px rgba(0, 0, 0, 0.18), inset 0 1px 0 rgba(255, 255, 255, 0.4);
            background: rgba(255, 255, 255, 0.2);
        }
        .device-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.7), transparent);
            border-radius: 26px 26px 0 0;
        }
        .device-field {
            color: #ffffff;
            font-size: 13px;
            margin: 8px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .device-field-label {
            opacity: 0.9;
            font-weight: 700;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }
        .device-field-value {
            font-weight: 800;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.25);
            word-break: break-all;
        }
        .device-delete-btn {
            margin-top: 14px;
            width: 100%;
            padding: 11px 18px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 800;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(239, 68, 68, 0.22);
            backdrop-filter: blur(60px);
            color: #ffffff;
            border: 1.5px solid rgba(239, 68, 68, 0.45);
            box-shadow: 0 10px 36px rgba(239, 68, 68, 0.25), inset 0 1px 0 rgba(255, 255, 255, 0.35);
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
        }
        .device-delete-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2.5px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.6), transparent);
            border-radius: 20px 20px 0 0;
        }
        .device-delete-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 18px 52px rgba(239, 68, 68, 0.45), inset 0 1px 0 rgba(255, 255, 255, 0.4);
            background: rgba(239, 68, 68, 0.28);
        }
        .no-devices {
            text-align: center;
            color: rgba(255, 255, 255, 0.85);
            font-size: 14px;
            font-weight: 700;
            padding: 20px;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }
        .error-message {
            background: rgba(239, 68, 68, 0.22);
            backdrop-filter: blur(60px);
            border-radius: 24px;
            padding: 14px 20px;
            margin-bottom: 14px;
            border: 1.5px solid rgba(239, 68, 68, 0.45);
            box-shadow: 0 10px 36px rgba(239, 68, 68, 0.25), inset 0 1px 0 rgba(255, 255, 255, 0.35);
            color: #ffffff;
            font-size: 13px;
            font-weight: 800;
            text-align: center;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
        }
        .error-message::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2.5px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.6), transparent);
            border-radius: 24px 24px 0 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="inner-container">
            <a href="javascript:window.close();" class="back-btn">‚Üê –ù–∞–∑–∞–¥</a>
            
            <div class="header">
                <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –≤ —Å—Ç–∏–ª–µ Apple Liquid Glass -->
                <div style="background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(60px); border-radius: 28px; padding: 22px 26px; border: 1.5px solid rgba(255, 255, 255, 0.3); box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12), inset 0 1px 0 rgba(255, 255, 255, 0.35); position: relative; overflow: hidden; margin-bottom: 18px;">
                    <div style="position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.7), transparent); border-radius: 28px 28px 0 0;"></div>
                    <div class="title">üîê –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∞–º–∏</div>
                    <div class="subtitle">–ö–ª–∏–µ–Ω—Ç: {{ client_name }} | Telegram: {{ telegram_username }}</div>
                </div>
                
                <!-- –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∫–µ—à–∞ -->
                <div style="margin-top: 18px;">
                    <button class="cache-delete-btn" onclick="deleteClientCache('{{ client_id }}', '{{ telegram_uid }}')">
                        üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –∫–µ—à –∫–ª–∏–µ–Ω—Ç–∞
                    </button>
                </div>
            </div>
            
            <div class="split-container">
                <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –ü–æ–¥–ø–∏—Å–∫–∏ -->
                <div>
                    {% for subscription in subscriptions_data %}
                    <div class="subscription-card">
                        <div class="subscription-name">{{ subscription.name }}</div>
                        <div class="subscription-expires">–î–æ: {{ subscription.expires }}</div>
                        <div class="button-container">
                            <button class="quickinstall-btn" onclick="copyToClipboard('{{ subscription.quickinstall }}')">
                                üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å QuickInstall
                            </button>
                            {% if (subscription.status == 'active' or subscription.status == 'expiring') and not subscription.is_router %}
                            <button class="replace-key-btn" onclick="replaceKey('{{ subscription.uuid or 'no-uuid' }}', '{{ subscription.name }}')">
                                üîÑ –ó–∞–º–µ–Ω–∏—Ç—å –∫–ª—é—á
                            </button>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: HWID —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ RemnaWave -->
                <div class="devices-panel">
                    <div class="devices-title">
                        <span>üì±</span>
                        <span>HWID –£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</span>
                    </div>
                    
                    {% if remnawave_error %}
                        {% if remnawave_error == 'no_remnawave_user' or remnawave_error == 'no_remnawave_subscription' %}
                        <div class="no-devices">‚ÑπÔ∏è –£ —é–∑–µ—Ä–∞ –Ω–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏ RemnaWave</div>
                        {% elif remnawave_error == 'api_unauthorized' %}
                        <div class="error-message">üö® –û–ø–∞, api —Ä–µ–º–Ω—ã —á–µ—Ç –Ω–µ –ø–∞—à–µ—Ç... –ù–∞–ø–∏—à–∏ –°–∞—à–µ, –æ–Ω —Ä–∞–∑–±–µ—Ä–µ—Ç—Å—è)</div>
                        {% else %}
                        <div class="error-message">‚ö†Ô∏è RemnaWave API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</div>
                        {% endif %}
                    {% elif remnawave_devices and remnawave_devices|length > 0 %}
                        {% for device in remnawave_devices %}
                        <div class="device-card">
                            <div class="device-field">
                                <span class="device-field-label">–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞:</span>
                                <span class="device-field-value">
                                    {% if 'android' in device.platform.lower() or 'ios' in device.platform.lower() or 'iphone' in device.platform.lower() %}
                                        üì± {{ device.platform }}
                                    {% elif 'windows' in device.platform.lower() or 'mac' in device.platform.lower() or 'linux' in device.platform.lower() %}
                                        üíª {{ device.platform }}
                                    {% else %}
                                        üñ•Ô∏è {{ device.platform }}
                                    {% endif %}
                                </span>
                            </div>
                            
                            <div class="device-field">
                                <span class="device-field-label">–ú–æ–¥–µ–ª—å:</span>
                                <span class="device-field-value">{{ device.deviceModel }}</span>
                            </div>
                            
                            <div class="device-field">
                                <span class="device-field-label">–û–°:</span>
                                <span class="device-field-value">{{ device.osVersion }}</span>
                            </div>
                            
                            <div class="device-field">
                                <span class="device-field-label">User Agent:</span>
                                <span class="device-field-value" style="font-size: 11px;">{{ device.userAgent }}</span>
                            </div>
                            
                            <div class="device-field">
                                <span class="device-field-label">HWID:</span>
                                <span class="device-field-value" style="font-size: 11px;">{{ device.hwid }}</span>
                            </div>
                            
                            <div class="device-field">
                                <span class="device-field-label">–°–æ–∑–¥–∞–Ω:</span>
                                <span class="device-field-value" style="font-size: 11px;">{{ device.createdAt[:10] }}</span>
                            </div>
                            
                            <div class="device-field">
                                <span class="device-field-label">–û–±–Ω–æ–≤–ª–µ–Ω:</span>
                                <span class="device-field-value" style="font-size: 11px;">{{ device.updatedAt[:10] }}</span>
                            </div>
                            
                            <button class="device-delete-btn" onclick="deleteDevice('{{ device.hwid }}', '{{ device.platform }} - {{ device.deviceModel }}')">
                                üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
                            </button>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="no-devices">üì≠ –ù–µ—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <script>
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(function() {
                alert('QuickInstall —Å—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
            }, function(err) {
                console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è: ', err);
                // Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('QuickInstall —Å—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
            });
        }
        
        function deleteClientCache(clientId, telegramUid) {
            if (confirm('üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –∫–µ—à –¥–ª—è —ç—Ç–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞?\\n\\n‚ö†Ô∏è –ü–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–ø—Ä–æ—à–µ–Ω—ã –∑–∞–Ω–æ–≤–æ —É –±–æ—Ç–∞.\\n‚úÖ –≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç –æ–±–Ω–æ–≤–∏—Ç—å —É—Å—Ç–∞—Ä–µ–≤—à—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.')) {
                // –ù–∞—Ö–æ–¥–∏–º –∫–Ω–æ–ø–∫—É –∏ –¥–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
                const button = document.querySelector('.cache-delete-btn');
                if (button) {
                    button.disabled = true;
                    button.style.opacity = '0.7';
                    button.style.transform = 'scale(0.98)';
                    button.innerHTML = '‚è≥ –£–¥–∞–ª–µ–Ω–∏–µ...';
                    button.style.background = 'rgba(59, 130, 246, 0.3)';
                    button.style.animation = 'pulse 1.5s infinite';
                }
                
                console.log('üóëÔ∏è –£–¥–∞–ª–µ–Ω–∏–µ –∫–µ—à–∞ –¥–ª—è:', clientId, telegramUid);
                console.log('URL:', '{{ copy_base }}{{ delete_cache_path }}');
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ –∫–µ—à–∞
                fetch('{{ copy_base }}{{ delete_cache_path }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        client_id: clientId,
                        telegram_uid: telegramUid
                    })
                })
                .then(response => {
                    console.log('üì° –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', response.status, response.statusText);
                    return response.json();
                })
                .then(data => {
                    console.log('üìã –î–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç–∞:', data);
                    // –£–±–∏—Ä–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é —Å –∫–Ω–æ–ø–∫–∏
                    if (button) {
                        button.style.animation = '';
                        button.disabled = false;
                        button.style.opacity = '1';
                        button.style.transform = 'scale(1)';
                    }
                    
                    if (data.success) {
                        // –£—Å–ø–µ—à–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ
                        if (button) {
                            button.innerHTML = '‚úÖ –£–¥–∞–ª–µ–Ω';
                            button.style.background = 'rgba(16, 185, 129, 0.3)';
                            setTimeout(() => {
                                button.innerHTML = 'üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –∫–µ—à –∫–ª–∏–µ–Ω—Ç–∞';
                                button.style.background = '';
                            }, 3000);
                        }
                        alert('‚úÖ –ö–µ—à –∫–ª–∏–µ–Ω—Ç–∞ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω!\\n\\nüîÑ –ü—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –∑–∞–ø—Ä–æ—Å–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –æ–±–Ω–æ–≤–ª–µ–Ω—ã.');
                    } else {
                        // –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è
                        if (button) {
                            button.innerHTML = '‚ùå –û—à–∏–±–∫–∞';
                            button.style.background = 'rgba(239, 68, 68, 0.3)';
                            setTimeout(() => {
                                button.innerHTML = 'üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –∫–µ—à –∫–ª–∏–µ–Ω—Ç–∞';
                                button.style.background = '';
                            }, 3000);
                        }
                        alert('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∫–µ—à–∞: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('‚ùå –û—à–∏–±–∫–∞:', error);
                    // –£–±–∏—Ä–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –ø—Ä–∏ –æ—à–∏–±–∫–µ
                    if (button) {
                        button.style.animation = '';
                        button.disabled = false;
                        button.style.opacity = '1';
                        button.style.transform = 'scale(1)';
                        button.innerHTML = '‚ùå –û—à–∏–±–∫–∞';
                        button.style.background = 'rgba(239, 68, 68, 0.3)';
                        setTimeout(() => {
                            button.innerHTML = 'üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –∫–µ—à –∫–ª–∏–µ–Ω—Ç–∞';
                            button.style.background = '';
                        }, 3000);
                    }
                    alert('‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–µ—à–∞: ' + error.message);
                });
            }
        }
        
        function replaceKey(uuid, subscriptionName) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ UUID
            if (!uuid || uuid === 'no-uuid' || uuid === 'None') {
                alert(`‚ùå –î–ª—è –ø–æ–¥–ø–∏—Å–∫–∏ "${subscriptionName}" –Ω–µ—Ç UUID –¥–ª—è –∑–∞–º–µ–Ω—ã –∫–ª—é—á–∞.\\n\\n–≠—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–æ–∏–∑–æ–π—Ç–∏ –µ—Å–ª–∏:\\n1. –ü–æ–¥–ø–∏—Å–∫–∞ –±—ã–ª–∞ —Å–æ–∑–¥–∞–Ω–∞ –¥–æ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã UUID\\n2. –î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã –Ω–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é\\n\\n–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É –¥–ª—è —Ä—É—á–Ω–æ–π –∑–∞–º–µ–Ω—ã –∫–ª—é—á–∞.`);
                return;
            }
            
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ—É—Ç–µ—Ä–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ frontend
            const routerPattern = /^[A-Fa-f0-9]{12}-router$/i;
            if (routerPattern.test(subscriptionName)) {
                alert(`‚ùå –ó–∞–º–µ–Ω–∞ –∫–ª—é—á–µ–π —Ä–æ—É—Ç–µ—Ä–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫ –∑–∞–ø—Ä–µ—â–µ–Ω–∞.\\n\\n–ü–æ–¥–ø–∏—Å–∫–∞ "${subscriptionName}" —è–≤–ª—è–µ—Ç—Å—è —Ä–æ—É—Ç–µ—Ä–Ω–æ–π –∏ –µ—ë –∫–ª—é—á –Ω–µ–ª—å–∑—è –∑–∞–º–µ–Ω–∏—Ç—å.`);
                return;
            }
            
            if (confirm(`üîÑ –ó–∞–º–µ–Ω–∏—Ç—å –∫–ª—é—á –¥–ª—è –ø–æ–¥–ø–∏—Å–∫–∏ "${subscriptionName}"?\\n\\n‚ö†Ô∏è –°—Ç–∞—Ä—ã–π –∫–ª—é—á –ø–µ—Ä–µ—Å—Ç–∞–Ω–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å.\\n‚úÖ –ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –∫–ª—é—á.`)) {
                // –ù–∞—Ö–æ–¥–∏–º –∫–Ω–æ–ø–∫—É –ø–æ UUID –∏ –¥–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
                const button = document.querySelector(`button[onclick*="${uuid}"]`);
                if (button) {
                    button.disabled = true;
                    button.style.opacity = '0.7';
                    button.style.transform = 'scale(0.98)';
                    button.innerHTML = '‚è≥ –ó–∞–º–µ–Ω–∞...';
                    button.style.background = 'rgba(59, 130, 246, 0.3)';
                    button.style.animation = 'pulse 1.5s infinite';
                }
                // –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ URL
                const urlParams = new URLSearchParams(window.location.search);
                const clientId = urlParams.get('client_id');
                const telegramUid = urlParams.get('telegram_uid');
                
                console.log('üîç –û—Ç–ª–∞–¥–∫–∞ –∑–∞–º–µ–Ω—ã –∫–ª—é—á–∞:');
                console.log('  uuid:', uuid);
                console.log('  clientId:', clientId);
                console.log('  telegramUid:', telegramUid);
                console.log('  URL:', '{{ copy_base }}{{ replace_key_path }}');
                console.log('‚è±Ô∏è Timeout: 70 —Å–µ–∫—É–Ω–¥ (–∂–¥–µ–º –æ—Ç–≤–µ—Ç –æ—Ç –±–æ—Ç–∞)');
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 70000);
                
                fetch('{{ copy_base }}{{ replace_key_path }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        client_id: clientId,
                        telegram_uid: telegramUid,
                        uuid: uuid
                    }),
                    signal: controller.signal
                })
                .then(response => {
                    clearTimeout(timeoutId);
                    console.log('üì° –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', response.status, response.statusText);
                    return response.json();
                })
                .then(data => {
                    console.log('üìã –î–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç–∞:', data);
                    if (button) {
                        button.style.animation = '';
                        button.disabled = false;
                        button.style.opacity = '1';
                        button.style.transform = 'scale(1)';
                    }
                    
                    if (data.success) {
                        if (button) {
                            button.innerHTML = '‚úÖ –ó–∞–º–µ–Ω–µ–Ω';
                            button.style.background = 'rgba(16, 185, 129, 0.3)';
                        }
                        
                        if (data.should_refresh) {
                            alert('‚úÖ ' + data.message + '\\n\\nüîÑ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–æ–≤–æ–≥–æ –∫–ª—é—á–∞.');
                            setTimeout(() => {
                                window.location.reload();
                            }, 1500);
                        } else if (data.new_quickinstall) {
                            alert('‚úÖ –ö–ª—é—á —É—Å–ø–µ—à–Ω–æ –∑–∞–º–µ–Ω–µ–Ω!\\n\\nüîó –ù–æ–≤—ã–π QuickInstall —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞');
                            copyToClipboard(data.new_quickinstall);
                            setTimeout(() => {
                                button.innerHTML = 'üîÑ –ó–∞–º–µ–Ω–∏—Ç—å –∫–ª—é—á';
                                button.style.background = '';
                            }, 3000);
                        }
                    } else {
                        if (button) {
                            button.innerHTML = '‚ùå –û—à–∏–±–∫–∞';
                            button.style.background = 'rgba(239, 68, 68, 0.3)';
                            setTimeout(() => {
                                button.innerHTML = 'üîÑ –ó–∞–º–µ–Ω–∏—Ç—å –∫–ª—é—á';
                                button.style.background = '';
                            }, 3000);
                        }
                        alert('‚ùå –û—à–∏–±–∫–∞ –∑–∞–º–µ–Ω—ã –∫–ª—é—á–∞: ' + data.error);
                    }
                })
                .catch(error => {
                    clearTimeout(timeoutId);
                    console.error('‚ùå –û—à–∏–±–∫–∞:', error);
                    if (button) {
                        button.style.animation = '';
                        button.disabled = false;
                        button.style.opacity = '1';
                        button.style.transform = 'scale(1)';
                        button.innerHTML = '‚ùå –û—à–∏–±–∫–∞';
                        button.style.background = 'rgba(239, 68, 68, 0.3)';
                        setTimeout(() => {
                            button.innerHTML = 'üîÑ –ó–∞–º–µ–Ω–∏—Ç—å –∫–ª—é—á';
                            button.style.background = '';
                        }, 3000);
                    }
                    
                    if (error.name === 'AbortError') {
                        alert('‚è±Ô∏è –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –æ–∂–∏–¥–∞–Ω–∏—è (70 —Å–µ–∫—É–Ω–¥).\\n\\n–ë–æ—Ç —Å–ª–∏—à–∫–æ–º –¥–æ–ª–≥–æ –æ—Ç–≤–µ—á–∞–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É.');
                    } else {
                        alert('‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–º–µ–Ω–µ –∫–ª—é—á–∞: ' + error.message);
                    }
                });
            }
        }
        
        function deleteDevice(hwid, deviceName) {
            if (confirm(`üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ "${deviceName}"?\\n\\nHWID: ${hwid}\\n\\n‚ö†Ô∏è –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`)) {
                const button = event.target;
                if (button) {
                    button.disabled = true;
                    button.style.opacity = '0.7';
                    button.style.transform = 'scale(0.98)';
                    button.innerHTML = '‚è≥ –£–¥–∞–ª–µ–Ω–∏–µ...';
                    button.style.animation = 'pulse 1.5s infinite';
                }
                
                console.log('üóëÔ∏è –£–¥–∞–ª–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞:', hwid, deviceName);
                console.log('üìç copy_base:', '{{ copy_base }}');
                console.log('üìç delete_device_path:', '{{ delete_device_path }}');
                console.log('üìç –ü–æ–ª–Ω—ã–π URL:', '{{ copy_base }}{{ delete_device_path }}');
                
                {% if remnawave_user and remnawave_user.uuid %}
                const userUuid = '{{ remnawave_user.uuid }}';
                {% else %}
                const userUuid = '';
                {% endif %}
                
                console.log('üìã user_uuid:', userUuid);
                console.log('üìã hwid:', hwid);
                
                const payload = {
                    user_uuid: userUuid,
                    hwid: hwid
                };
                console.log('üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º JSON:', JSON.stringify(payload, null, 2));
                
                fetch('{{ copy_base }}{{ delete_device_path }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                })
                .then(response => {
                    console.log('üì° –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', response.status, response.statusText);
                    console.log('üì° response.ok:', response.ok);
                    console.log('üì° response.url:', response.url);
                    
                    if (!response.ok) {
                        return response.text().then(text => {
                            console.error('‚ùå –û—Ç–≤–µ—Ç –ù–ï OK, –ø–æ–ª—É—á–µ–Ω —Ç–µ–∫—Å—Ç:', text.substring(0, 200));
                            throw new Error(`HTTP ${response.status}: ${text.substring(0, 100)}`);
                        });
                    }
                    
                    return response.json();
                })
                .then(data => {
                    console.log('üìã –î–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç–∞:', data);
                    if (button) {
                        button.style.animation = '';
                        button.disabled = false;
                        button.style.opacity = '1';
                        button.style.transform = 'scale(1)';
                    }
                    
                    if (data.success) {
                        if (button) {
                            button.innerHTML = '‚úÖ –£–¥–∞–ª–µ–Ω–æ';
                            button.style.background = 'rgba(16, 185, 129, 0.3)';
                        }
                        alert('‚úÖ –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–æ!\\n\\nüîÑ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∞.');
                        setTimeout(() => {
                            window.location.reload();
                        }, 1500);
                    } else {
                        if (button) {
                            button.innerHTML = '‚ùå –û—à–∏–±–∫–∞';
                            setTimeout(() => {
                                button.innerHTML = 'üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ';
                                button.style.background = '';
                            }, 3000);
                        }
                        alert('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('‚ùå –û—à–∏–±–∫–∞:', error);
                    if (button) {
                        button.style.animation = '';
                        button.disabled = false;
                        button.style.opacity = '1';
                        button.style.transform = 'scale(1)';
                        button.innerHTML = '‚ùå –û—à–∏–±–∫–∞';
                        setTimeout(() => {
                            button.innerHTML = 'üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ';
                            button.style.background = '';
                        }, 3000);
                    }
                    alert('‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞: ' + error.message);
                });
            }
        }
    </script>
</body>
</html>

